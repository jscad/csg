const test = require('ava')
const opentype = require('opentype.js')
const { vector_text, vector_char, text } = require('./text')
const { comparePositonVertices } = require('./test-helpers')
const robotoRegular = opentype.loadSync(__dirname + '/../fonts/Roboto-Regular.ttf')

test('vector_char', t => {
  const obs = vector_char(0, 2, 'O')
  const expSegments = [ [ [ 9, 23 ],
    [ 7, 22 ],
    [ 5, 20 ],
    [ 4, 18 ],
    [ 3, 15 ],
    [ 3, 10 ],
    [ 4, 7 ],
    [ 5, 5 ],
    [ 7, 3 ],
    [ 9, 2 ],
    [ 13, 2 ],
    [ 15, 3 ],
    [ 17, 5 ],
    [ 18, 7 ],
    [ 19, 10 ],
    [ 19, 15 ],
    [ 18, 18 ],
    [ 17, 20 ],
    [ 15, 22 ],
    [ 13, 23 ],
    [ 9, 23 ] ] ]

  t.deepEqual(obs.width, 22)
  t.deepEqual(obs.segments, expSegments)
})

test('vector_text', t => {
  const obs = vector_text(0, 0, 'Hi')
  const exp = [ [ [ 4, 21 ], [ 4, 0 ] ],
    [ [ 18, 21 ], [ 18, 0 ] ],
    [ [ 4, 11 ], [ 18, 11 ] ],
    [ [ 25, 21 ], [ 26, 20 ], [ 27, 21 ], [ 26, 22 ], [ 25, 21 ] ],
    [ [ 26, 14 ], [ 26, 0 ] ] ]

  t.deepEqual(obs, exp)
})

test('text({ text, font })', t => {
  const obs = text({ text: 'OpenJSCAD', font: robotoRegular })

  const slice1 = [
    [[69.37669376693768, 0], [70.34816320385426, 0.03036234066044365]],
    [[70.34816320385426, 0.03036234066044365], [70.6310266711111, 0.07442798987254214]],
    [[70.6310266711111, 0.07442798987254214], [70.88657921139492, 0.15322296061958743]],
    [[70.88657921139492, 0.15322296061958743], [71.1602233820692, 0.27798223798424543]],
    [[71.1602233820692, 0.27798223798424543], [71.70392953929539, 0.575880758807588]],
    [[71.70392953929539, 0.575880758807588], [72.42710528957141, 1.0104888085917898]],
    [[72.42710528957141, 1.0104888085917898], [72.62405691869242, 1.177032317241833]],
    [[72.62405691869242, 1.177032317241833], [72.78692358571709, 1.3717624208198593]],
    [[72.78692358571709, 1.3717624208198593], [72.94570930963081, 1.6261370775573325]],
    [[72.94570930963081, 1.6261370775573325], [73.2418699186992, 2.1883468834688347]]
  ]

  const slice2 = [
    [[33.26914024623225, 0.13586506788128433], [33.49827333750841, 0.002237053198036823]],
    [[33.49827333750841, 0.002237053198036823], [33.66511643556188, -0.05785298303004766]],
    [[33.66511643556188, -0.05785298303004766], [33.855129548602804, -0.0972941447140428]],
    [[33.855129548602804, -0.0972941447140428], [34.21254939572716, -0.12724859758885654]],
    [[34.21254939572716, -0.12724859758885654], [35, -0.13550135501355012]],
    [[35, -0.13550135501355012], [36.02792833483891, -0.10589179965873734]],
    [[36.02792833483891, -0.10589179965873734], [36.31349315512664, -0.046266522208990794]],
    [[36.31349315512664, -0.046266522208990794], [36.47737630987435, 0.020681791133009362]],
    [[36.47737630987435, 0.020681791133009362], [36.63534824698053, 0.11478009457020137]],
    [[36.63534824698053, 0.11478009457020137], [36.80050910591411, 0.2406496630124052]]
  ]

  const slice3 = [
    [[5.168996703916535, 1.0850099365367503], [5.042049157557402, 1.0367291942642687]],
    [[5.284542005066497, 1.1520235863378319], [5.168996703916535, 1.0850099365367503]],
    [[5.471390961695482, 1.315653142699563], [5.284542005066497, 1.1520235863378319]],
    [[5.675560291798508, 1.5557146536541169], [5.471390961695482, 1.315653142699563]],
    [[5.928184281842818, 1.8868563685636857], [5.675560291798508, 1.5557146536541169]],
    [[6.294316749751859, 2.3917522611440107], [5.928184281842818, 1.8868563685636857]],
    [[6.447781689370011, 2.6628189940640454], [6.294316749751859, 2.3917522611440107]],
    [[6.54493952727974, 2.941370209693561], [6.447781689370011, 2.6628189940640454]],
    [[6.599668774465524, 3.2787563986750983], [6.54493952727974, 2.941370209693561]],
    [[6.639566395663957, 4.518970189701897], [6.599668774465524, 3.2787563986750983]]
  ]

  t.deepEqual(obs.sides.length, 748)
  // test only a few slices at different place
  t.truthy(comparePositonVertices(obs.sides.slice(0, 10), slice1))
  t.truthy(comparePositonVertices(obs.sides.slice(obs.sides.length / 2, obs.sides.length / 2 + 10), slice2))
  t.truthy(comparePositonVertices(obs.sides.slice(obs.sides.length - 10), slice3))
})

test('text({ text, font, center })', t => {
  const obs = text({ text: 'OpenJSCAD', font: robotoRegular, center: [true, true] })

  const slice1 = [
    [[32.486449864498645, -5], [33.45791930141524, -4.969637659339556]],
    [[33.45791930141524, -4.969637659339556], [33.74078276867207, -4.925572010127458]],
    [[33.74078276867207, -4.925572010127458], [33.9963353089559, -4.846777039380412]],
    [[33.9963353089559, -4.846777039380412], [34.26997947963019, -4.722017762015755]],
    [[34.26997947963019, -4.722017762015755], [34.81368563685637, -4.424119241192412]],
    [[34.81368563685637, -4.424119241192412], [35.5368613871324, -3.9895111914082104]],
    [[35.5368613871324, -3.9895111914082104], [35.7338130162534, -3.8229676827581667]],
    [[35.7338130162534, -3.8229676827581667], [35.89667968327806, -3.6282375791801407]],
    [[35.89667968327806, -3.6282375791801407], [36.0554654071918, -3.3738629224426675]],
    [[36.0554654071918, -3.3738629224426675], [36.35162601626016, -2.8116531165311653]]
  ]

  const slice2 = [
    [[-3.6211036562067775, -4.8641349321187155], [-3.3919705649306167, -4.997762946801963]],
    [[-3.3919705649306167, -4.997762946801963], [-3.2251274668771472, -5.057852983030048]],
    [[-3.2251274668771472, -5.057852983030048], [-3.035114353836221, -5.097294144714043]],
    [[-3.035114353836221, -5.097294144714043], [-2.677694506711866, -5.127248597588856]],
    [[-2.677694506711866, -5.127248597588856], [-1.8902439024390247, -5.13550135501355]],
    [[-1.8902439024390247, -5.13550135501355], [-0.8623155676001133, -5.105891799658737]],
    [[-0.8623155676001133, -5.105891799658737], [-0.5767507473123814, -5.046266522208991]],
    [[-0.5767507473123814, -5.046266522208991], [-0.4128675925646732, -4.9793182088669905]],
    [[-0.4128675925646732, -4.9793182088669905], [-0.25489565545849757, -4.885219905429799]],
    [[-0.25489565545849757, -4.885219905429799], [-0.08973479652491534, -4.759350336987595]]
  ]

  const slice3 = [
    [[-31.72124719852249, -3.9149900634632497], [-31.848194744881624, -3.963270805735731]],
    [[-31.605701897372526, -3.847976413662168], [-31.72124719852249, -3.9149900634632497]],
    [[-31.41885294074354, -3.684346857300437], [-31.605701897372526, -3.847976413662168]],
    [[-31.214683610640517, -3.4442853463458833], [-31.41885294074354, -3.684346857300437]],
    [[-30.962059620596207, -3.1131436314363143], [-31.214683610640517, -3.4442853463458833]],
    [[-30.595927152687167, -2.6082477388559893], [-30.962059620596207, -3.1131436314363143]],
    [[-30.442462213069014, -2.3371810059359546], [-30.595927152687167, -2.6082477388559893]],
    [[-30.345304375159284, -2.058629790306439], [-30.442462213069014, -2.3371810059359546]],
    [[-30.2905751279735, -1.7212436013249017], [-30.345304375159284, -2.058629790306439]],
    [[-30.25067750677507, -0.48102981029810277], [-30.2905751279735, -1.7212436013249017]]
  ]

  t.deepEqual(obs.sides.length, 748)
  // test only a few slices at different place
  t.truthy(comparePositonVertices(obs.sides.slice(0, 10), slice1))
  t.truthy(comparePositonVertices(obs.sides.slice(obs.sides.length / 2, obs.sides.length / 2 + 10), slice2))
  t.truthy(comparePositonVertices(obs.sides.slice(obs.sides.length - 10), slice3))
})

test('text({ text, font, height })', t => {
  const obs = text({ text: 'OpenJSCAD', font: robotoRegular, height: 20 })

  const slice1 = [
    [[138.75338753387535, 0], [140.6963264077085, 0.0607246813208873]],
    [[140.6963264077085, 0.0607246813208873], [141.2620533422222, 0.14885597974508427]],
    [[141.2620533422222, 0.14885597974508427], [141.77315842278983, 0.30644592123917486]],
    [[141.77315842278983, 0.30644592123917486], [142.3204467641384, 0.5559644759684909]],
    [[142.3204467641384, 0.5559644759684909], [143.40785907859077, 1.151761517615176]],
    [[143.40785907859077, 1.151761517615176], [144.85421057914283, 2.0209776171835796]],
    [[144.85421057914283, 2.0209776171835796], [145.24811383738484, 2.354064634483666]],
    [[145.24811383738484, 2.354064634483666], [145.57384717143418, 2.7435248416397187]],
    [[145.57384717143418, 2.7435248416397187], [145.89141861926163, 3.252274155114665]],
    [[145.89141861926163, 3.252274155114665], [146.4837398373984, 4.376693766937669]]
  ]

  const slice2 = [
    [[66.5382804924645, 0.27173013576256866], [66.99654667501682, 0.004474106396073646]],
    [[66.99654667501682, 0.004474106396073646], [67.33023287112375, -0.11570596606009532]],
    [[67.33023287112375, -0.11570596606009532], [67.71025909720561, -0.1945882894280856]],
    [[67.71025909720561, -0.1945882894280856], [68.42509879145432, -0.2544971951777131]],
    [[68.42509879145432, -0.2544971951777131], [70, -0.27100271002710025]],
    [[70, -0.27100271002710025], [72.05585666967782, -0.21178359931747467]],
    [[72.05585666967782, -0.21178359931747467], [72.62698631025329, -0.09253304441798159]],
    [[72.62698631025329, -0.09253304441798159], [72.9547526197487, 0.041363582266018724]],
    [[72.9547526197487, 0.041363582266018724], [73.27069649396105, 0.22956018914040274]],
    [[73.27069649396105, 0.22956018914040274], [73.60101821182822, 0.4812993260248104]]
  ]

  const slice3 = [
    [[10.33799340783307, 2.1700198730735005], [10.084098315114804, 2.0734583885285374]],
    [[10.569084010132993, 2.3040471726756637], [10.33799340783307, 2.1700198730735005]],
    [[10.942781923390964, 2.631306285399126], [10.569084010132993, 2.3040471726756637]],
    [[11.351120583597016, 3.1114293073082337], [10.942781923390964, 2.631306285399126]],
    [[11.856368563685637, 3.7737127371273713], [11.351120583597016, 3.1114293073082337]],
    [[12.588633499503718, 4.7835045222880215], [11.856368563685637, 3.7737127371273713]],
    [[12.895563378740022, 5.325637988128091], [12.588633499503718, 4.7835045222880215]],
    [[13.08987905455948, 5.882740419387122], [12.895563378740022, 5.325637988128091]],
    [[13.199337548931048, 6.5575127973501965], [13.08987905455948, 5.882740419387122]],
    [[13.279132791327914, 9.037940379403794], [13.199337548931048, 6.5575127973501965]]
  ]

  t.deepEqual(obs.sides.length, 748)
  // test only a few slices at different place
  t.truthy(comparePositonVertices(obs.sides.slice(0, 10), slice1))
  t.truthy(comparePositonVertices(obs.sides.slice(obs.sides.length / 2, obs.sides.length / 2 + 10), slice2))
  t.truthy(comparePositonVertices(obs.sides.slice(obs.sides.length - 10), slice3))
})

test('text({ text, font, width })', t => {
  const obs = text({ text: 'OpenJSCAD', font: robotoRegular, width: 100 })

  const slice1 = [
    [[94.03122130394858, 0], [95.34792368125703, 0.041152263374485604]],
    [[95.34792368125703, 0.041152263374485604], [95.73130887654725, 0.10087760610823891]],
    [[95.73130887654725, 0.10087760610823891], [96.07767760883277, 0.2076740953852259]],
    [[96.07767760883277, 0.2076740953852259], [96.44856722858967, 0.3767693142926963]],
    [[96.44856722858967, 0.3767693142926963], [97.18549127640037, 0.7805325987144168]],
    [[97.18549127640037, 0.7805325987144168], [98.16566336768358, 1.3695881372649052]],
    [[98.16566336768358, 1.3695881372649052], [98.43260607161619, 1.5953165291542202]],
    [[98.43260607161619, 1.5953165291542202], [98.65335097568268, 1.8592482397889003]],
    [[98.65335097568268, 1.8592482397889003], [98.86856468412773, 2.204020501813244]],
    [[98.86856468412773, 2.204020501813244], [99.26997245179064, 2.966023875114784]]
  ]

  const slice2 = [
    [[45.092057854397424, 0.18414769531017045], [45.40261840786264, 0.0030320390452730165]],
    [[45.40261840786264, 0.0030320390452730165], [45.62875285481113, -0.07841230757791583]],
    [[45.62875285481113, -0.07841230757791583], [45.886291289015375, -0.13186974986035552]],
    [[45.886291289015375, -0.13186974986035552], [46.3707281066054, -0.17246917359150804]],
    [[46.3707281066054, -0.17246917359150804], [47.438016528925615, -0.18365472910927455]],
    [[47.438016528925615, -0.18365472910927455], [48.83124171002959, -0.14352276978539605]],
    [[48.83124171002959, -0.14352276978539605], [49.21828824331213, -0.06270834415102884]],
    [[49.21828824331213, -0.06270834415102884], [49.44041086627597, 0.02803151856044247]],
    [[49.44041086627597, 0.02803151856044247], [49.65452159094881, 0.1555697149546531]],
    [[49.65452159094881, 0.1555697149546531], [49.87837597826375, 0.3261697911903674]]
  ]

  const slice3 = [
    [[7.005912887952988, 1.4705919800993974], [6.833851750738958, 1.405153618672232]],
    [[7.162519742404177, 1.5614203980116068], [7.005912887952988, 1.4705919800993974]],
    [[7.415769567917842, 1.7831993008489944], [7.162519742404177, 1.5614203980116068]],
    [[7.692494940950043, 2.1085719272667367], [7.415769567917842, 1.7831993008489944]],
    [[8.034894398530762, 2.557392102846648], [7.692494940950043, 2.1085719272667367]],
    [[8.531140057514916, 3.2417138084927086], [8.034894398530762, 2.557392102846648]],
    [[8.739142124435386, 3.6091100415413506], [8.531140057514916, 3.2417138084927086]],
    [[8.870827127883283, 3.986650532146645], [8.739142124435386, 3.6091100415413506]],
    [[8.945005611672277, 4.443934292419141], [8.870827127883283, 3.986650532146645]],
    [[8.999081726354452, 6.124885215794307], [8.945005611672277, 4.443934292419141]]
  ]

  t.deepEqual(obs.sides.length, 748)
  // test only a few slices at different place
  t.truthy(comparePositonVertices(obs.sides.slice(0, 10), slice1))
  t.truthy(comparePositonVertices(obs.sides.slice(obs.sides.length / 2, obs.sides.length / 2 + 10), slice2))
  t.truthy(comparePositonVertices(obs.sides.slice(obs.sides.length - 10), slice3))
})

test('text({ text, font, letterSpacing })', t => {
  const obs = text({ text: 'OpenJSCAD', font: robotoRegular, letterSpacing: 10 })

  const slice1 = [
    [[149.37669376693768, 0], [150.34816320385426, 0.03036234066044365]],
    [[150.34816320385426, 0.03036234066044365], [150.6310266711111, 0.07442798987254214]],
    [[150.6310266711111, 0.07442798987254214], [150.88657921139492, 0.15322296061958743]],
    [[150.88657921139492, 0.15322296061958743], [151.1602233820692, 0.27798223798424543]],
    [[151.1602233820692, 0.27798223798424543], [151.70392953929542, 0.575880758807588]],
    [[151.70392953929542, 0.575880758807588], [152.42710528957144, 1.0104888085917898]],
    [[152.42710528957144, 1.0104888085917898], [152.62405691869242, 1.177032317241833]],
    [[152.62405691869242, 1.177032317241833], [152.7869235857171, 1.3717624208198593]],
    [[152.7869235857171, 1.3717624208198593], [152.94570930963084, 1.6261370775573325]],
    [[152.94570930963084, 1.6261370775573325], [153.2418699186992, 2.1883468834688347]]
  ]

  const slice2 = [
    [[73.26914024623224, 0.13586506788128433], [73.49827333750841, 0.002237053198036823]],
    [[73.49827333750841, 0.002237053198036823], [73.66511643556188, -0.05785298303004766]],
    [[73.66511643556188, -0.05785298303004766], [73.8551295486028, -0.0972941447140428]],
    [[73.8551295486028, -0.0972941447140428], [74.21254939572717, -0.12724859758885654]],
    [[74.21254939572717, -0.12724859758885654], [75, -0.13550135501355012]],
    [[75, -0.13550135501355012], [76.02792833483892, -0.10589179965873734]],
    [[76.02792833483892, -0.10589179965873734], [76.31349315512665, -0.046266522208990794]],
    [[76.31349315512665, -0.046266522208990794], [76.47737630987436, 0.020681791133009362]],
    [[76.47737630987436, 0.020681791133009362], [76.63534824698053, 0.11478009457020137]],
    [[76.63534824698053, 0.11478009457020137], [76.8005091059141, 0.2406496630124052]]
  ]

  const slice3 = [
    [[5.168996703916535, 1.0850099365367503], [5.042049157557402, 1.0367291942642687]],
    [[5.284542005066497, 1.1520235863378319], [5.168996703916535, 1.0850099365367503]],
    [[5.471390961695482, 1.315653142699563], [5.284542005066497, 1.1520235863378319]],
    [[5.675560291798508, 1.5557146536541169], [5.471390961695482, 1.315653142699563]],
    [[5.928184281842818, 1.8868563685636857], [5.675560291798508, 1.5557146536541169]],
    [[6.294316749751859, 2.3917522611440107], [5.928184281842818, 1.8868563685636857]],
    [[6.447781689370011, 2.6628189940640454], [6.294316749751859, 2.3917522611440107]],
    [[6.54493952727974, 2.941370209693561], [6.447781689370011, 2.6628189940640454]],
    [[6.599668774465524, 3.2787563986750983], [6.54493952727974, 2.941370209693561]],
    [[6.639566395663957, 4.518970189701897], [6.599668774465524, 3.2787563986750983]]
  ]

  t.deepEqual(obs.sides.length, 748)
  // test only a few slices at different place
  t.truthy(comparePositonVertices(obs.sides.slice(0, 10), slice1))
  t.truthy(comparePositonVertices(obs.sides.slice(obs.sides.length / 2, obs.sides.length / 2 + 10), slice2))
  t.truthy(comparePositonVertices(obs.sides.slice(obs.sides.length - 10), slice3))
})
